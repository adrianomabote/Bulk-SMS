
let tentativas = 0;
let jaRegistrou = localStorage.getItem('jaRegistrou') === 'true';

// Mapeamento da roleta (12 segmentos de 30¬∞ cada, come√ßando do topo em sentido hor√°rio)
// A seta est√° na posi√ß√£o 3 horas (90¬∞ do topo)
// Centro de cada segmento a partir do topo (12h) em sentido hor√°rio
const SEGMENTOS = {
    '500_verde': 15,        // Segmento 1
    'BOA_SORTE_1': 45,      // Segmento 2 (vermelho superior) 
    '500_azul': 75,         // Segmento 3
    '10000': 105,           // Segmento 4
    '5000_azul': 135,       // Segmento 5 - ESTE √â O 5.000!
    '1000_laranja': 165,    // Segmento 6
    'BOA_SORTE_2': 195,     // Segmento 7 (rosa)
    '5000_verde': 225,      // Segmento 8
    'BOA_SORTE_3': 255,     // Segmento 9 (vermelho inferior)
    '1000_vermelho': 285,   // Segmento 10
    '10': 315,              // Segmento 11
    '100': 345              // Segmento 12
};

// Audio Context para sons
let audioContext = null;

function getAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioContext;
}

// Som de spinning (cliques)
function playSpinSound(duration) {
    const ctx = getAudioContext();
    const startTime = ctx.currentTime;
    const endTime = startTime + duration;
    
    let clickCount = 0;
    const totalClicks = 60;
    
    function playClick(time, frequency, volume) {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'square';
        osc.frequency.value = frequency;
        
        gain.gain.setValueAtTime(volume, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
        
        osc.start(time);
        osc.stop(time + 0.05);
    }
    
    for (let i = 0; i < totalClicks; i++) {
        const progress = i / totalClicks;
        const clickTime = Math.pow(progress, 2) * duration;
        const frequency = 800 - (progress * 400);
        const volume = 0.3 * (1 - progress * 0.7);
        
        if (startTime + clickTime < endTime) {
            playClick(startTime + clickTime, frequency, volume);
        }
    }
}

// Som de vit√≥ria (fanfarra)
function playVictorySound() {
    const ctx = getAudioContext();
    const startTime = ctx.currentTime;
    
    const notes = [
        { freq: 523.25, time: 0, duration: 0.15 },
        { freq: 659.25, time: 0.15, duration: 0.15 },
        { freq: 783.99, time: 0.3, duration: 0.15 },
        { freq: 1046.50, time: 0.45, duration: 0.4 },
        { freq: 783.99, time: 0.55, duration: 0.15 },
        { freq: 1046.50, time: 0.7, duration: 0.5 }
    ];
    
    notes.forEach(note => {
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        osc.type = 'sine';
        osc.frequency.value = note.freq;
        
        const noteStart = startTime + note.time;
        gain.gain.setValueAtTime(0.3, noteStart);
        gain.gain.exponentialRampToValueAtTime(0.001, noteStart + note.duration);
        
        osc.start(noteStart);
        osc.stop(noteStart + note.duration);
    });
}

// Iniciar countdown
function startCountdown() {
    let timeLeft = 120;
    
    const timer = setInterval(() => {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        
        document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
        document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');
        
        if (timeLeft <= 0) {
            clearInterval(timer);
        }
        timeLeft--;
    }, 1000);
}

// Marcar que usu√°rio se registrou
function marcarRegistro() {
    localStorage.setItem('jaRegistrou', 'true');
    jaRegistrou = true;
    setTimeout(() => {
        document.getElementById('popup').style.display = 'none';
    }, 100);
}

// Fun√ß√£o principal de girar
function girarRoleta() {
    // Verificar se j√° usou as 2 tentativas (incluindo sess√µes anteriores)
    const tentativasUsadas = parseInt(localStorage.getItem('tentativasUsadas') || '0');
    
    if (tentativasUsadas >= 2 || tentativas >= 2) {
        mostrarMensagemCompartilhar();
        return;
    }
    
    const roleta = document.getElementById('roleta');
    tentativas++;
    
    // Salvar tentativas no localStorage
    localStorage.setItem('tentativasUsadas', tentativas.toString());
    
    let premio, targetAngle;
    
    if (tentativas === 1) {
        premio = 'BOA SORTE';
        targetAngle = SEGMENTOS.BOA_SORTE_1;
    } else {
        premio = 5000;
        targetAngle = SEGMENTOS['5000_azul'];
    }
    
    window.premioAtual = premio;
    
    const voltas = tentativas === 1 ? 8 : 12;
    let finalAngle = 90 - targetAngle;
    if (finalAngle < 0) finalAngle += 360;
    
    const totalRotation = (360 * voltas) + finalAngle;
    const duration = tentativas === 1 ? 7 : 6;
    
    playSpinSound(duration);
    
    roleta.style.transition = `transform ${duration}s cubic-bezier(0.1, 0.8, 0.3, 1)`;
    roleta.style.transform = `rotate(${totalRotation}deg)`;
    
    document.getElementById('girarBtn').disabled = true;
    
    setTimeout(() => {
        setTimeout(showPopUp, 500);
    }, duration * 1000);
}

// Mostrar popup com resultado
function showPopUp() {
    let mensagem = '';
    const btnGirarNovamente = document.getElementById('girarNovamente');
    const btnRegistro = document.getElementById('popupButton');
    const premio = window.premioAtual;
    
    if (premio === 'BOA SORTE') {
        if (tentativas === 1) {
            mensagem = '‚ùå N√£o foi dessa vez!<br>Voc√™ tem mais 1 chance.<br>Clique no bot√£o abaixo e gire novamente!';
            btnGirarNovamente.style.display = 'inline-block';
            btnRegistro.style.display = 'none';
        } else {
            mensagem = 'üòÖ Boa sorte!<br>Voc√™ esgotou suas 2 tentativas gr√°tis.<br>Tente novamente mais tarde!';
            btnGirarNovamente.style.display = 'none';
            btnRegistro.style.display = 'none';
        }
    } else {
        if (tentativas === 1) {
            mensagem = `üéâ Parab√©ns! Voc√™ ganhou <b>${premio.toLocaleString('pt-BR')} Meticais!</b><br><br>Voc√™ tem mais 1 chance para girar e ganhar ainda mais!<br>Clique abaixo para fazer sua segunda tentativa!`;
            btnGirarNovamente.style.display = 'inline-block';
            btnRegistro.style.display = 'none';
        } else {
            mensagem = `ü§ë Parab√©ns! Voc√™ ganhou <b>${premio.toLocaleString('pt-BR')} Meticais!</b><br><br>Para receber, registre-se na plataforma clicando no bot√£o abaixo e <b>deposite 1 ou 5 Meticais</b> para que possamos confirmar seu n√∫mero e enviar o valor.<br><br>‚ö†Ô∏è <b>O pr√™mio s√≥ ser√° entregue para quem criar uma nova conta na plataforma.</b><br>Se j√° possui uma conta, √© necess√°rio criar uma nova para receber o valor na sua carteira m√≥vel!`;
            btnGirarNovamente.style.display = 'none';
            btnRegistro.style.display = 'inline-block';
            playVictorySound();
            startConfetti();
        }
    }
    
    document.getElementById('popupText').innerHTML = mensagem;
    document.getElementById('popup').style.display = 'block';
}

// Confetti
function startConfetti() {
    if (typeof confetti === 'undefined') return;
    
    const duration = 3000;
    const end = Date.now() + duration;

    (function frame() {
        confetti({
            particleCount: 5,
            angle: 60,
            spread: 55,
            origin: { x: 0 }
        });
        confetti({
            particleCount: 5,
            angle: 120,
            spread: 55,
            origin: { x: 1 }
        });

        if (Date.now() < end) {
            requestAnimationFrame(frame);
        }
    }());
}

// Fechar popup e girar novamente
function fecharPopUpEGirar() {
    document.getElementById('popup').style.display = 'none';
    document.getElementById('girarBtn').disabled = false;
    girarRoleta();
}

// Mostrar mensagem para compartilhar
function mostrarMensagemCompartilhar() {
    const mensagem = '‚ö†Ô∏è Voc√™ j√° usou suas 2 tentativas gr√°tis!<br><br>üì≤ Para ganhar mais giros, compartilhe este site com seus amigos no WhatsApp.<br><br>Cada pessoa que entrar pelo seu link te d√° +1 giro gr√°tis!';
    document.getElementById('popupText').innerHTML = mensagem;
    
    const btnGirarNovamente = document.getElementById('girarNovamente');
    const btnRegistro = document.getElementById('popupButton');
    
    // Criar bot√£o de compartilhar se n√£o existir
    let btnCompartilhar = document.getElementById('btnCompartilharPopup');
    if (!btnCompartilhar) {
        btnCompartilhar = document.createElement('button');
        btnCompartilhar.id = 'btnCompartilharPopup';
        btnCompartilhar.innerHTML = 'üì≤ COMPARTILHAR AGORA';
        btnCompartilhar.onclick = function() {
            document.getElementById('popup').style.display = 'none';
            abrirCompartilhar();
        };
        btnCompartilhar.style.background = 'linear-gradient(135deg, #25D366, #128C7E)';
        btnCompartilhar.style.marginTop = '15px';
        btnCompartilhar.style.display = 'inline-block';
        document.querySelector('.popup-content').appendChild(btnCompartilhar);
    }
    
    btnGirarNovamente.style.display = 'none';
    btnRegistro.style.display = 'none';
    btnCompartilhar.style.display = 'inline-block';
    document.getElementById('popup').style.display = 'block';
}

// Copiar texto para compartilhar
function copyText() {
    const textArea = document.getElementById('shareText');
    textArea.select();
    textArea.setSelectionRange(0, 99999);
    document.execCommand('copy');
    alert('Mensagem copiada! Agora cole no WhatsApp ou SMS.');
}

// Abrir modal de compartilhar
function abrirCompartilhar() {
    document.getElementById('shareModal').style.display = 'block';
}

// Fechar modal de compartilhar
function fecharCompartilhar() {
    document.getElementById('shareModal').style.display = 'none';
}

// Fechar modal ao clicar fora dele
window.onclick = function(event) {
    const modal = document.getElementById('shareModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}

// Iniciar quando p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    startCountdown();
    
    // Carregar tentativas anteriores
    const tentativasUsadas = parseInt(localStorage.getItem('tentativasUsadas') || '0');
    tentativas = tentativasUsadas;
    
    // Se j√° se registrou, esconder popup caso esteja vis√≠vel
    if (jaRegistrou) {
        document.getElementById('popup').style.display = 'none';
    }
});

// Prote√ß√µes b√°sicas
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
    if ((e.ctrlKey && ['u', 's', 'c', 'i'].includes(e.key.toLowerCase())) || 
        e.keyCode === 123 || 
        (e.ctrlKey && e.shiftKey && ['i', 'j', 'c'].includes(e.key.toLowerCase()))) {
        e.preventDefault();
    }
});
document.addEventListener('selectstart', e => e.preventDefault());
